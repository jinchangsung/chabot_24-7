<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chatbot JINPD Admin - ì§€ì‹ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f4f7f6; color: #2d3436; }
        .admin-section { max-width: 900px; margin: 0 auto; }
        .knowledge-card { background: white; margin-bottom: 30px; padding: 25px; border-radius: 12px; border: 2px solid #0984e3; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .knowledge-card h3 { margin-top: 0; color: #0984e3; }
        #knowledge-input { width: 100%; height: 120px; padding: 15px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 14px; resize: none; box-sizing: border-box; }
        .save-btn { margin-top: 15px; padding: 12px 25px; background: #00b894; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .save-btn:hover { background: #009477; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff5f0; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ffdab9; }
        .user-group { background: white; margin-bottom: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .user-id { font-weight: bold; color: #007bff; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .chat-line { margin: 8px 0; padding: 8px; border-radius: 6px; font-size: 14px; }
        .role-user { background: #f1f3f5; }
        .role-bot { color: #28a745; background: #f0fff4; border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <div class="admin-section">
        <h1>Global JINPD AI ê´€ë¦¬ì ëª¨ë“œ</h1>

        <div class="knowledge-card">
            <h3>ğŸ“š ì±—ë´‡ ì§€ì‹ ì°½ê³  ë°ì´í„° ë“±ë¡</h3>
            <p style="font-size: 13px; color: #636e72;">ê°„ë‹¨í•œ ì§€ì‹ì„ ì§ì ‘ íƒ€ì´í•‘í•˜ì—¬ ë“±ë¡í•©ë‹ˆë‹¤.</p>
            <textarea id="knowledge-input" placeholder="í•™ìŠµí•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <button class="save-btn" onclick="saveKnowledge()">ì§€ì‹ ì €ì¥í•˜ê¸°</button>

            <div style="border-top: 1px dashed #dfe6e9; margin-top: 25px; padding-top: 20px;">
                <h3 style="color: #6c5ce7;">ğŸš€ ì´ˆê³ ì† ì§€ì‹ í¡ìˆ˜ (JSON ë²Œí¬ ì—…ë¡œë“œ)</h3>
                <p style="font-size: 13px; color: #636e72;">ìµœëŒ€ 100ê°œì˜ JSON íŒŒì¼ì„ í•œë²ˆì— ì„ íƒí•˜ì—¬ í•™ìŠµì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <input type="file" id="json-files" accept=".json" multiple style="margin-bottom: 10px; font-size: 14px;">
                <br>
                <button class="save-btn" onclick="uploadJSONBulk()" style="background: #6c5ce7;">JSON ë²Œí¬ í•™ìŠµ ì‹œì‘</button>
            </div>
        </div>

        <div class="knowledge-card" style="border-color: #fab1a0;">
            <h3 style="color: #e17055;">ğŸ—‚ï¸ ì§€ì‹ íŒŒì¼ ê´€ë¦¬í•¨</h3>
            <div id="file-list-container">
                <p style="font-size: 14px; color: #b2bec3;">í•™ìŠµëœ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <hr style="border: 0; height: 1px; background: #dfe6e9; margin: 40px 0;">
        <h2>ì‹¤ì‹œê°„ ëŒ€í™” ëª¨ë‹ˆí„°ë§</h2>
        <div id="history-container">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // ì§ì ‘ í…ìŠ¤íŠ¸ ì €ì¥
        function saveKnowledge() {
            const content = $('#knowledge-input').val().trim();
            if(!content) { alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            $.ajax({
                url: '/api/admin/add_knowledge',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ content: content }),
                success: function() {
                    alert("ì§€ì‹ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    $('#knowledge-input').val('');
                    loadFileList();
                }
            });
        }

        // [ìˆ˜ì •] JSON ë²Œí¬ ì—…ë¡œë“œ í•¨ìˆ˜ (FormData êµ¬ì„± ë°©ì‹ ê°œì„ )
        function uploadJSONBulk() {
            const fileInput = document.getElementById('json-files');
            const files = fileInput.files;
            if (files.length === 0) { alert("JSON íŒŒì¼ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            const btn = event.target;
            btn.innerText = `${files.length}ê°œ íŒŒì¼ í•™ìŠµ ì¤‘...`;
            btn.disabled = true;

            $.ajax({
                url: '/api/admin/upload_json',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    alert(response.message);
                    fileInput.value = '';
                    loadFileList(); // íŒŒì¼ ëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 
                },
                error: function(xhr) {
                    alert("í•™ìŠµì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
                },
                complete: function() {
                    btn.innerText = "JSON ë²Œí¬ í•™ìŠµ ì‹œì‘";
                    btn.disabled = false;
                }
            });
        }

        // [ìˆ˜ì •] ì§€ì‹ íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì‚­ì œ ë¡œì§ í†µí•©
        function loadFileList() {
            $.get('/api/admin/knowledge_files', function(data) {
                const container = $('#file-list-container');
                container.empty();
                if (!data || data.length === 0) {
                    container.html('<p style="font-size: 14px; color: #b2bec3;">í•™ìŠµëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
                    return;
                }
                data.forEach(filename => {
                    if(filename) {
                        const fileHtml = `
                            <div class="file-item">
                                <span style="font-size: 14px;">ğŸ“„ ${filename}</span>
                                <button onclick="deleteFile('${filename}')" style="padding: 5px 10px; background: #ff7675; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                            </div>`;
                        container.append(fileHtml);
                    }
                });
            });
        }

        // íŠ¹ì • íŒŒì¼ ì‚­ì œ
        function deleteFile(filename) {
            if(!confirm(`'${filename}'ì˜ ì§€ì‹ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?`)) return;
            $.ajax({
                url: '/api/admin/delete_knowledge',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ filename: filename }),
                success: function() {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadFileList();
                }
            });
        }

        // ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
        function loadData() {
            $.get('/api/admin/history', function(data) {
                const container = $('#history-container');
                container.empty();
                if (!data || data.length === 0) {
                    container.html('<p>ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
                    return;
                }
                const grouped = {};
                data.forEach(item => {
                    if (!grouped[item.user_id]) grouped[item.user_id] = [];
                    grouped[item.user_id].push(item);
                });
                for (const userId in grouped) {
                    let html = `<div class="user-group"><div class="user-id">User: ${userId}</div>`;
                    grouped[userId].forEach(msg => {
                        html += `<div class="chat-line role-${msg.role}"><strong>${msg.role.toUpperCase()}:</strong> ${msg.message}</div>`;
                    });
                    html += `</div>`;
                    container.append(html);
                }
            });
        }

        $(document).ready(function() {
            loadFileList();
            loadData();
            setInterval(loadData, 5000);
        });
    </script>
</body>
</html>